{% extends "base.html" %}
{% block title %}View Tickets{% endblock %}

{% block content %}

<div class="container mt-4">

    <h2 class="mb-4 text-center">All Tickets</h2>

    <!-- Filters -->
    <div class="d-flex gap-2 mb-3 justify-content-center">
        <button class="btn btn-outline-primary btn-sm" data-filter="all">All</button>
        <button class="btn btn-outline-danger btn-sm" data-filter="high">High</button>
        <button class="btn btn-outline-warning btn-sm" data-filter="medium">Medium</button>
        <button class="btn btn-outline-success btn-sm" data-filter="low">Low</button>
    </div>

    {% if tickets %}
    <div class="row g-3">
        {% for t in tickets %}
        <div class="col-md-6 col-lg-4 ticket-card-wrapper"
             data-severity="{{ t.get('severity_impact', t.get('severity','none')) }}">

            <div class="card shadow-sm h-100">
                <div class="card-body">

                    <!-- Ticket ID + Title -->
                    <div class="d-flex justify-content-between">
                        <h6 class="text-muted">INC{{ t.id }}</h6>
                        <span class="fw-bold">{{ t.title }}</span>
                    </div>

                    <!-- Severity + urgency badges -->
                    <div class="mt-2">
                        {% set sev = (t.get('severity_impact', t.get('severity','none'))).lower() %}
                        <span class="badge bg-{% if sev=='high' %}danger{% elif sev=='medium' %}warning text-dark{% else %}success{% endif %}">
                            {{ sev.capitalize() }}
                        </span>

                        <span class="badge bg-info">
                            {{ t.get('urgency','Low')|capitalize }}
                        </span>
                    </div>

                    <hr>

                    <!-- Operator + Schedule -->
                    <p class="mb-1"><strong>Operator:</strong> {{ t.get('operator','-') }}</p>
                    <p class="mb-1">
                        <strong>Estimated:</strong> {{ t.get('start_time','-') }} →
                        {{ t.get('end_time','-') }}
                    </p>

                    <p class="mt-3 text-secondary">{{ t.get('description','') }}</p>

                    <div class="d-flex justify-content-end">

                        <!-- Delete button -->
                        <form action="{{ url_for('delete_ticket', ticket_id=t.id) }}" method="POST">
                            <button class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>

                        <!-- Status dropdown -->
                        <div class="btn-group ms-2">
                            <button id="status-btn-{{ t.id }}"
                                class="btn btn-sm dropdown-toggle
                                    {% if t.status == 'approved' %}btn-success
                                    {% elif t.status == 'denied' %}btn-danger
                                    {% elif t.status == 'ack' %}btn-warning
                                    {% elif t.status == 'resolved' %}btn-primary
                                    {% else %}btn-secondary
                                    {% endif %}"
                                data-bs-toggle="dropdown">
                                {{ t.status|capitalize if t.status else "Status" }}
                            </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="ack" href="#">Acknowledge</a></li>
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="approved"  href="#"
                                        data-ticket-name="{{ t.title }}"
                                        data-ticket-operator="{{ t.operator }}"
                                        data-ticket-description="{{ t.description }}"> Approved  </a></li>
                                    
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="denied" href="#">Denied</a></li>
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="resolved" href="#">Resolved</a></li>
                                </ul>
                        </div>

                    </div>

                </div>
            </div>

        </div>
        {% endfor %}
    </div>

    {% else %}
    <p class="text-center text-muted mt-4">Noet.</p>
    {% endif %}

</div>

<div class="modal fade" id="jobModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Create New Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{{ url_for('new_job') }}">
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Name</label>
            <input name="name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Operator</label>
            <input name="operator" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>

          <!-- Impact + Customer Impact -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Impact</label>
              <select name="impact" class="form-select">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Impact on Customer</label>
              <select name="impactCustomer" class="form-select">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          </div>

          <!-- Impact Description -->
          <div class="mb-3">
            <label class="form-label">Impact Details</label>
            <textarea name="impactDesc" class="form-control" rows="2"></textarea>
          </div>

          <!-- Start & End Time -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Start Time</label>
              <input type="datetime-local" name="time_start" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">End Time</label>
              <input type="datetime-local" name="time_end" class="form-control" required>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Create</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
// Filtering
document.querySelectorAll('[data-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
        const f = btn.dataset.filter;
        document.querySelectorAll('.ticket-card-wrapper').forEach(card => {
            card.style.display = (f === 'all' || card.dataset.severity === f) ? "" : "none";
        });
    });
});

document.querySelectorAll(".status-action").forEach(item => {
    item.addEventListener("click", function (e) {
        e.preventDefault();

        const id = this.dataset.id;
        const status = this.dataset.status;

        // Ask for confirmation first
        const ok = confirm(`Are you sure you want to change Ticket #${id} to "${status}"?`);
        if (!ok) return;

        // Status update
        updateStatus(id, status);

        // If approved → prefill modal + show it
        if (status === "approved") {

            // Prefill fields using the <a> data- attributes
            document.querySelector("#jobModal input[name='name']").value =
                this.dataset.ticketName || "";

            document.querySelector("#jobModal input[name='operator']").value =
                this.dataset.ticketOperator || "";

            document.querySelector("#jobModal textarea[name='description']").value =
                this.dataset.ticketDescription || "";

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById("jobModal"));
            modal.show();
        }
    });
});


// Update Ticket Status -------------------------
function updateStatus(id, status) {

    fetch(`/update_status/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: status })
    })
    .then(res => res.json())
    .then(data => {

        const btn = document.querySelector(`#status-btn-${id}`);

        // Update button text
        btn.textContent = status.charAt(0).toUpperCase() + status.slice(1);

        // Remove old colors
        btn.classList.remove(
            "btn-success", "btn-danger", "btn-warning",
            "btn-primary", "btn-secondary"
        );

        // Apply new color
        if (status === "approved") btn.classList.add("btn-success");
        else if (status === "denied") btn.classList.add("btn-danger");
        else if (status === "ack") btn.classList.add("btn-warning");
        else if (status === "resolved") btn.classList.add("btn-primary");
        else btn.classList.add("btn-secondary");

    })
    .catch(err => {
        alert("Error updating status.");
        console.error(err);
    });
}
</script>




{% endblock %}
