{% extends "base.html" %}
{% block title %}View Tickets{% endblock %}

{% block content %}

<div class="container mt-4">

    <h2 class="mb-4 text-center">All Tickets</h2>

    <!-- Filters -->
    <div class="d-flex gap-2 mb-3 justify-content-center">
        <button class="btn btn-outline-primary btn-sm" data-filter="all">All</button>
        <button class="btn btn-outline-danger btn-sm" data-filter="high">High</button>
        <button class="btn btn-outline-warning btn-sm" data-filter="medium">Medium</button>
        <button class="btn btn-outline-success btn-sm" data-filter="low">Low</button>
    </div>

    {% if tickets %}
    <div class="row g-3">
        {% for t in tickets %}
        <div class="col-md-6 col-lg-4 ticket-card-wrapper"
             data-severity="{{ t.get('severity_impact', t.get('severity','none')) }}">

            <div class="card shadow-sm h-100">
                <div class="card-body">

                    <!-- Ticket ID + Title -->
                    <div class="d-flex justify-content-between">
                        <h6 class="text-muted">INC{{ t.id }}</h6>
                        <span class="fw-bold">{{ t.title }}</span>
                    </div>

                    <!-- Severity + urgency badges -->
                    <div class="mt-2">
                        {% set sev = (t.get('severity_impact', t.get('severity','none'))).lower() %}
                        <span class="badge bg-{% if sev=='high' %}danger{% elif sev=='medium' %}warning text-dark{% else %}success{% endif %}">
                            {{ sev.capitalize() }}
                        </span>

                        <span class="badge bg-info">
                            {{ t.get('urgency','Low')|capitalize }}
                        </span>
                    </div>

                    <hr>

                    <!-- Operator + Schedule -->
                    <p class="mb-1"><strong>Operator:</strong> {{ t.get('operator','-') }}</p>
                    <p class="mb-1">
                        <strong>Estimated:</strong> {{ t.get('start_time','-') }} â†’
                        {{ t.get('end_time','-') }}
                    </p>

                    <p class="mt-3 text-secondary">{{ t.get('description','') }}</p>

                    <div class="d-flex justify-content-end">

                        <!-- Delete button -->
                        <form action="{{ url_for('delete_ticket', ticket_id=t.id) }}" method="POST">
                            <button class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>

                        <!-- Status dropdown -->
                        <div class="btn-group ms-2">
                            <button id="status-btn-{{ t.id }}"
                                class="btn btn-sm dropdown-toggle
                                    {% if t.status == 'approved' %}btn-success
                                    {% elif t.status == 'denied' %}btn-danger
                                    {% elif t.status == 'ack' %}btn-warning
                                    {% elif t.status == 'resolved' %}btn-primary
                                    {% else %}btn-secondary
                                    {% endif %}"
                                data-bs-toggle="dropdown">
                                {{ t.status|capitalize if t.status else "Status" }}
                            </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="ack" href="#">Acknowledge</a></li>
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="approved" href="#">Approved</a></li>
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="denied" href="#">Denied</a></li>
                                <li><a class="dropdown-item status-action" data-id="{{ t.id }}" data-status="resolved" href="#">Resolved</a></li>
                                </ul>
                        </div>

                    </div>

                </div>
            </div>

        </div>
        {% endfor %}
    </div>

    {% else %}
    <p class="text-center text-muted mt-4">Noet.</p>
    {% endif %}

</div>

<script>
// Filtering
document.querySelectorAll('[data-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
        const f = btn.dataset.filter;
        document.querySelectorAll('.ticket-card-wrapper').forEach(card => {
            card.style.display = (f === 'all' || card.dataset.severity === f) ? "" : "none";
        });
    });
});

document.querySelectorAll(".status-action").forEach(item => {
    item.addEventListener("click", function (e) {
        e.preventDefault();  // prevents browser navigation
        updateStatus(this.dataset.id, this.dataset.status);
    });
});

// Update Ticket Status
function updateStatus(id, status) {
    const ok = confirm(`Are you sure you want to change Ticket #${id} to "${status}"?`);
    if (!ok) return;

    fetch(`/update_status/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: status })
    })
    .then(res => res.json())
    .then(data => {

        const btn = document.querySelector(`#status-btn-${id}`);

        // Update button text
        btn.textContent = status.charAt(0).toUpperCase() + status.slice(1);

        // REMOVE ONLY THE COLOR CLASSES
        btn.classList.remove(
            "btn-success",
            "btn-danger",
            "btn-warning",
            "btn-primary",
            "btn-secondary"
        );

        // DO NOT REMOVE dropdown-toggle and btn classes !!!

        // Apply new color
        if (status === "approved") btn.classList.add("btn-success");
        else if (status === "denied") btn.classList.add("btn-danger");
        else if (status === "ack") btn.classList.add("btn-warning");
        else if (status === "resolved") btn.classList.add("btn-primary");
        else btn.classList.add("btn-secondary");

    })
    .catch(err => {
        alert("Error updating status.");
        console.error(err);
    });
}
</script>

{% endblock %}
 tickets y